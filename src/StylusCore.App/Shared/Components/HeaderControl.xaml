<UserControl x:Class="StylusCore.App.Shared.Components.HeaderControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:StylusCore.App.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="48" d:DesignWidth="800"
             Height="{DynamicResource Shell.HeaderHeight}">

    <!-- Main Header Grid -->
    <Grid Background="Transparent">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/> <!-- 0: Identity (Icon + Title) -->
            <ColumnDefinition Width="*"/>    <!-- 1: Drag Region -->
            <ColumnDefinition Width="Auto"/> <!-- 2: Window Controls -->
        </Grid.ColumnDefinitions>

        <!-- COL 0: IDENTITY (No Drag) -->
        <!-- Visible in Library, App Name Hidden in Editor -->
        <StackPanel Grid.Column="0" 
                    Orientation="Horizontal" 
                    WindowChrome.IsHitTestVisibleInChrome="True"
                    Margin="12,0,0,0">
            
            <!-- Home/Library Button -->
            <Button Command="{Binding NavigateToLibraryRootCommand}"
                    Style="{DynamicResource IconButtonStyle}"
                    Height="32" Width="32"
                    VerticalAlignment="Center"
                    ToolTip="{DynamicResource Str_Library}">
                <!-- App Icon / Logo Placeholder -->
                <!-- Using a simple rectangle/path for now if no dedicated Icon.Logo exists, or just S text -->
                <Grid>
                    <Path Data="{StaticResource Icon.Library}" 
                          Style="{StaticResource IconBase}"
                          Stroke="{DynamicResource PrimaryAccentBrush}"
                          StrokeThickness="2.5"/>
                </Grid>
            </Button>

            <!-- App Name (Visible ONLY when IsEditorActive is FALSE) -->
            <TextBlock Text="{DynamicResource Str_AppName}" 
                       FontSize="14"
                       FontWeight="SemiBold"
                       VerticalAlignment="Center"
                       Margin="12,0,0,0"
                       Foreground="{DynamicResource PrimaryTextBrush}"
                       Visibility="{Binding IsEditorActive, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
        </StackPanel>

        <!-- COL 1: DRAG REGION (Allow Drag) -->
        <!-- WindowChrome.IsHitTestVisibleInChrome="False" means "Hit test goes to WindowChrome", which handles dragging.
             If we set it to True, the element eats the click and prevents drag.
             So for dragging, we generally want IsHitTestVisibleInChrome="False" on the background/container,
             or just ensure NO element with IsHitTestVisibleInChrome="True" is blocking it.
             Since the WindowChrome declaration in MainWindow covers the whole caption height, 
             clicks on transparent areas fall through to the WindowChrome (Drag).
             The only thing we need to be careful of is NOT putting a "True" element here. 
             We leave this empty or explicitly False. -->
        <Grid Grid.Column="1" Background="Transparent" WindowChrome.IsHitTestVisibleInChrome="False"/>

        <!-- COL 2: WINDOW CONTROLS (No Drag) -->
        <StackPanel Grid.Column="2" 
                    Orientation="Horizontal" 
                    WindowChrome.IsHitTestVisibleInChrome="True"
                    VerticalAlignment="Top"
                    HorizontalAlignment="Right">

            <!-- Minimize -->
            <Button Command="{Binding MinimizeCommand}" 
                    Style="{DynamicResource CaptionButtonStyle}"
                    ToolTip="{DynamicResource Str_Tooltip_Minimize}">
                <Path Data="{StaticResource Icon.WindowMinimize}" 
                      Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" 
                      StrokeThickness="1" 
                      SnapsToDevicePixels="True"/>
            </Button>

            <!-- Maximize / Restore -->
            <Button Command="{Binding MaximizeCommand}" 
                    Style="{DynamicResource CaptionButtonStyle}">
                <Button.ToolTip>
                     <ToolTip Content="{DynamicResource Str_Tooltip_Maximize}"/>
                </Button.ToolTip>
                <Grid>
                    <!-- Maximize Icon (Show when Normal) -->
                    <Path Data="{StaticResource Icon.WindowMaximize}" 
                          Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" 
                          StrokeThickness="1" 
                          SnapsToDevicePixels="True"
                          Visibility="{Binding WindowState, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource NullToVisibilityConverter}}"/>
                          <!-- TODO: Accurate WindowState binding requires a converter comparing to 'Maximized'. 
                               For now static Maximize icon is acceptable for MVP compliance, 
                               or we rely on the button command to toggle. -->
                </Grid>
            </Button>

            <!-- Close -->
            <Button Command="{Binding CloseCommand}" 
                    Style="{DynamicResource CaptionCloseButtonStyle}"
                    ToolTip="{DynamicResource Str_Tooltip_Close}">
                <Path Data="{StaticResource Icon.WindowClose}" 
                      Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" 
                      StrokeThickness="1" 
                      SnapsToDevicePixels="True"/>
            </Button>
        </StackPanel>
    </Grid>
</UserControl>
